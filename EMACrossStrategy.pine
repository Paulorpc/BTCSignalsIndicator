//@version=5
strategy("EMA Cross Strategy", overlay=true)

// Set custom range for backtesting
start = timestamp(2021, 1, 1, 0, 0)
end = timestamp(2024, 12, 31, 23, 59)

testPeriod() =>
    time >= start and time <= end ? true : false

ema21 = ta.ema(close, 15)
ema50 = ta.ema(close, 25)
ema40 = ta.ema(close, 40)

plot(ema21, color=color.orange, linewidth=2)
plot(ema50, color=color.red, linewidth=2)
plot(ema40, color=color.blue, linewidth=2)

a = array.new_float(0)
for i = 0 to 15
    array.push(a, close[i])
//plot(array.avg(a))

longCond = ta.crossover(ema21, ema50)
shortCond = ta.crossunder(ema21, ema50)

// Check for a change in momentum before making a sell entry
mom = ta.mom(close, 15)
momChange = ta.change(mom)
momDntrend = momChange < 0

// Check for an uptrend in momentum
momUptrend = momChange > 0

// Check for a sideways market
avgPrice = array.avg(a)
priceDiff = math.abs(close - avgPrice)
sidewaysMarket = priceDiff < 0.5 * ta.atr(15)

if (testPeriod() and longCond and momDntrend and not sidewaysMarket)
    strategy.entry("Buy", strategy.long)

if (testPeriod() and shortCond and momUptrend and not sidewaysMarket)
    strategy.entry("Sell", strategy.short)
